name: OpenJDK Android Build

on:
  push:
    branches:
      - master
  workflow_dispatch:

jobs:
  build-openjdk-android:
    runs-on: ubuntu-22.04

    steps:
    - name: üßæ Checkout source code
      uses: actions/checkout@v3

    - name: üñ•Ô∏è Check Ubuntu Architecture and Bitness
      run: |
        echo "üß† uname -m output:"
        uname -m
        echo "üß† lscpu architecture:"
        lscpu | grep Architecture
        echo "üß† Bitness:"
        getconf LONG_BIT

    - name: üß∞ Install Required Tools
      run: |
        sudo apt update
        sudo apt install -y build-essential clang zip unzip \
           libxext-dev libxrender-dev libxtst-dev \
          libxt-dev libasound2-dev libcups2-dev libfreetype6-dev \
          autoconf make pkg-config

    - name: üì• Download Android NDK r25c
      run: |
        wget https://dl.google.com/android/repository/android-ndk-r25c-linux.zip
        unzip android-ndk-r25c-linux.zip
        mv android-ndk-r25c $HOME/android-ndk

    - name: ‚öôÔ∏è Set up NDK Environment Variables
      run: |
        echo "ANDROID_NDK_HOME=$HOME/android-ndk" >> $GITHUB_ENV
        echo "$HOME/android-ndk/toolchains/llvm/prebuilt/linux-x86_64/bin" >> $GITHUB_PATH
        echo "$HOME/android-ndk/toolchains/arm-linux-androideabi-4.9/prebuilt/linux-x86_64/bin" >> $GITHUB_PATH
        echo "TARGET_HOST=armv7a-linux-androideabi" >> $GITHUB_ENV
        echo "API_LEVEL=24" >> $GITHUB_ENV
        echo "CLANG_PATH=$HOME/android-ndk/toolchains/llvm/prebuilt/linux-x86_64" >> $GITHUB_ENV
        echo "TOOLS_DIR=$HOME/android-ndk/toolchains/llvm/prebuilt/linux-x86_64/bin" >> $GITHUB_ENV
        # Explicit compiler and tool paths
        echo "CC=$HOME/android-ndk/toolchains/llvm/prebuilt/linux-x86_64/bin/clang" >> $GITHUB_ENV
        echo "CXX=$HOME/android-ndk/toolchains/llvm/prebuilt/linux-x86_64/bin/clang++" >> $GITHUB_ENV
        echo "AR=$HOME/android-ndk/toolchains/llvm/prebuilt/linux-x86_64/bin/llvm-ar" >> $GITHUB_ENV
        echo "STRIP=$HOME/android-ndk/toolchains/llvm/prebuilt/linux-x86_64/bin/llvm-strip" >> $GITHUB_ENV
        echo "NM=$HOME/android-ndk/toolchains/llvm/prebuilt/linux-x86_64/bin/llvm-nm" >> $GITHUB_ENV
        echo "OBJCOPY=$HOME/android-ndk/toolchains/llvm/prebuilt/linux-x86_64/bin/llvm-objcopy" >> $GITHUB_ENV
        echo "OBJDUMP=$HOME/android-ndk/toolchains/llvm/prebuilt/linux-x86_64/bin/llvm-objdump" >> $GITHUB_ENV
        echo "RANLIB=$HOME/android-ndk/toolchains/llvm/prebuilt/linux-x86_64/bin/llvm-ranlib" >> $GITHUB_ENV
        echo "READELF=$HOME/android-ndk/toolchains/llvm/prebuilt/linux-x86_64/bin/llvm-readelf" >> $GITHUB_ENV

    - name: ‚òï Set up JDK 16 (Boot JDK)
      uses: actions/setup-java@v3
      with:
        distribution: 'temurin'
        java-version: '16'

    - name: üîç Show Java and NDK Info
      run: |
        java -version
        $CC --version
        echo "NDK tools:"
        ls $TOOLS_DIR
        echo "Environment variables:"
        env | sort

    - name: ‚öôÔ∏è Configure OpenJDK for Android
      run: |
        bash configure \
          --openjdk-target=arm-linux-androideabi \
          --with-sysroot=$CLANG_PATH/sysroot \
          --with-boot-jdk=$JAVA_HOME \
          --disable-warnings-as-errors \
          --with-debug-level=release \
          --with-jvm-variants=client \
          --enable-headless-only \
          --with-toolchain-type=clang \
          --with-tools-dir=$TOOLS_DIR \
          --with-extra-cflags="--target=armv7a-linux-androideabi$API_LEVEL -fPIE" \
          --with-extra-cxxflags="--target=armv7a-linux-androideabi$API_LEVEL -fPIE" \
          --with-extra-ldflags="-pie" \
          GCC="$CC" \
          GXX="$CXX" \
          AR="$AR" \
          STRIP="$STRIP" \
          NM="$NM" \
          OBJCOPY="$OBJCOPY" \
          OBJDUMP="$OBJDUMP" \
          RANLIB="$RANLIB" \
          READELF="$READELF"

    - name: üß± Build OpenJDK
      run: |
        make images JOBS=2

    - name: üì¶ Upload Built JDK Artifacts
      uses: actions/upload-artifact@v4
      with:
        name: openjdk-android-armv7
        path: build/*/images/jdk