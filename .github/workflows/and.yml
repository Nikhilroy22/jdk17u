name: OpenJDK Android Build

on:
  push:
    branches:
      - master
  workflow_dispatch:

jobs:
  build-openjdk-android:
    runs-on: ubuntu-22.04

    steps:
    - name: üßæ Checkout source code
      uses: actions/checkout@v3

    - name: üñ•Ô∏è Check Ubuntu Architecture and Bitness
      run: |
        echo "üß† uname -m output:"
        uname -m

        echo "üß† lscpu architecture:"
        lscpu | grep Architecture

        echo "üß† Bitness:"
        getconf LONG_BIT

    - name: üì• Download Android NDK
      run: |
        wget https://dl.google.com/android/repository/android-ndk-r25c-linux.zip
        unzip android-ndk-r25c-linux.zip
        mv android-ndk-r25c "$HOME/android-ndk"

    - name: ‚öôÔ∏è Set up environment variables
      run: |
        echo "ANDROID_NDK_HOME=$HOME/android-ndk" >> "$GITHUB_ENV"
        echo "$HOME/android-ndk/toolchains/llvm/prebuilt/linux-x86_64/bin" >> "$GITHUB_PATH"
        echo "TARGET_HOST=armv7a-linux-androideabi" >> "$GITHUB_ENV"
        echo "API_LEVEL=24" >> "$GITHUB_ENV"

    - name: ‚òï Set up JDK 16 (for bootstrap)
      uses: actions/setup-java@v3
      with:
        distribution: 'temurin'
        java-version: '16'

    - name: üîç Show environment info
      run: |
        java -version
        echo "ANDROID_NDK_HOME: $ANDROID_NDK_HOME"
        ls "$ANDROID_NDK_HOME/toolchains/llvm/prebuilt/linux-x86_64/bin"

    - name: ‚öôÔ∏è Configure OpenJDK for Android (ARMv7)
      run: |
        bash configure \
          --openjdk-target=arm-linux-androideabi \
          --with-sysroot=$ANDROID_NDK_HOME/toolchains/llvm/prebuilt/linux-x86_64/sysroot \
          --with-boot-jdk=$JAVA_HOME \
          --disable-warnings-as-errors \
          --with-debug-level=release \
          --with-jvm-variants=client \
          --enable-headless-only \
          --with-toolchain-type=clang \
          --with-extra-cflags="-fPIE" \
          --with-extra-cxxflags="-fPIE" \
          --with-extra-ldflags="-pie"

    - name: üß± Build OpenJDK
      run: |
        make images

    - name: üì¶ Upload Built JDK Artifacts
      uses: actions/upload-artifact@v4
      with:
        name: openjdk-android
        path: build/*/images/jdk